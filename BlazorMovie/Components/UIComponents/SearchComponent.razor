@using BlazorMovie.Services.Interfaces
@using BlazorMovie.Models

@inject ISearchService searchService
@inject NavigationManager NavManager


<div class="row">
    <div class="col-12 d-flex justify-content-end">
        @if (string.IsNullOrWhiteSpace(searchModel.Category))
        {
            <select @bind="searchModel.Category" class="form-select">
                <option value="">Select Category</option>
                <option value="MovieByTitle">Movie By Title</option>
                <option value="PopularMovies">Popular Movies</option>
                <option value="TopRated">Top Rated</option>
                <option value="Upcoming">Upcoming</option>
                <option value="NowPlaying">Now Playing</option>
            </select>

        }
        else 
        {
            <div class="input-group">
                <select @bind="searchModel.Category" class="form-select">
                    <option value="">Select Category</option>
                    <option value="MovieByTitle">Movie By Title</option>
                    <option value="PopularMovies">Popular Movies</option>
                    <option value="TopRated">Top Rated</option>
                    <option value="Upcoming">Upcoming</option>
                    <option value="NowPlaying">Now Playing</option>
                </select>
                @if (searchModel.Category == "MovieByTitle" && IsSearchActive)
                {
                    <input type="text" class="form-control" placeholder="@Placeholder" @bind="searchTerm" @onkeyup="HandleKeyUp"/>
                    <button class="btn btn-primary" type="submit" @onclick="PerformSearch">Search</button>
                    <button class="btn btn-danger border border-2" @onclick="OnClearSearchClick">Clear Search</button>
                }
                
            </div>
        }

    </div>

</div>
@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger mt-3" role="alert">
        @errorMessage
    </div>
}

@code {
    #region PARAMETERS
    [Parameter]
    public string Placeholder { get; set; } = "Enter Search Term";

    [Parameter]
    public bool IsSearchActive { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<SearchModel>> OnMultipleResultsFound { get; set; }

    [Parameter]
    public EventCallback OnClearSearch { get; set; }
    #endregion

    private bool showSearchBox = false;
    private string searchTerm = string.Empty;
    private IEnumerable<SearchModel> searchResults = [];
    private string errorMessage = string.Empty;
    private SearchModel? Category { get; set; }
    private SearchModel searchModel { get; set; } = new SearchModel();
    public NavigationManager NavigationManager { get; set; } = null!;

    #region CATEGORY CHANGED
    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        searchModel.Category = e.Value?.ToString() ?? string.Empty;
        showSearchBox = searchModel.Category == "MovieByTitle"; // Show input box only for MovieByTitle

        if (!showSearchBox && !string.IsNullOrWhiteSpace(searchModel.Category))
        {
            await FetchMoviesByCategory(searchModel.Category);
            // Map category to route
            var route = searchModel.Category switch
            {
                "PopularMovies" => "/",
                "TopRated" => "/top_rated",
                "Upcoming" => "/upcoming",
                "NowPlaying" => "/now_playing",
                _ => "/"
            };

            // Navigate to the route
            NavigationManager.NavigateTo(route);
        }
    }
    #endregion

    #region PERFORM SEARCH
    private async Task PerformSearch()
    {
        if (!await ValidateSearchTerm())
            return;

        await FetchSearchResults();

        if (searchResults == null || !searchResults.Any())
        {
            await ShowErrorMessage("No results found.");
            return;
        }

        if (searchResults.Count() > 1)
        {
            await HandleMultipleResults();
        }
        else
        {
            HandleSingleResult(searchResults.First());
        }
        IsSearchActive = true;
    }
    #endregion

    #region FETCH SEARCH RESULTS
    private async Task FetchSearchResults()
    {
        try
        {
            Console.WriteLine($"Category: {searchModel.Category}, SearchTerm: {searchTerm}");
            searchResults = await searchService.GetSearchModelAsync(searchModel.Category, searchTerm);
            Console.WriteLine($"Search Results Count: {searchResults?.Count()}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching search results: {ex.Message}");
            await ShowErrorMessage("An error occurred while fetching search results.");
        }
    }
    #endregion

    #region FETCH BY CATEGORY
    private async Task FetchMoviesByCategory(string category)
    {
        try
        {
            searchResults = await searchService.GetMoviesByCategoryAsync(category);
            if (searchResults != null && searchResults.Any())
            {
                Console.WriteLine($"Movies fetched for category {category}: {searchResults.Count()}");
                IsSearchActive = true;
            }
            else
            {
                await ShowErrorMessage("No results found for the selected category.");
            }

            StateHasChanged();
        }
        catch (Exception)
        {
            
            throw;
        }
    }
    #endregion

#region HANDLE KEY UP
    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch(); // Trigger the search on Enter key press
        }
    }
#endregion

#region CLEAR SEARCH
    private async Task OnClearSearchClick()
    {
        IsSearchActive = false;
        searchTerm = string.Empty; // Clear text input
        searchModel.Category = string.Empty; // Reset dropdown
       await OnCategoryChanged(new ChangeEventArgs { Value = string.Empty }); // Trigger the category change logic
        searchResults = Enumerable.Empty<SearchModel>(); // Clear results
        await OnClearSearch.InvokeAsync(); // Trigger parent callback (if any)
        StateHasChanged(); // Update the UI
    }
#endregion

#region VALIDATE SEARCH
    private async Task<bool> ValidateSearchTerm()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await ShowErrorMessage("Please enter a search term.");
            return false;
        }
        return true;
    }
    #endregion

 #region SHOW ERROR MESSAGE
    private async Task ShowErrorMessage(string message)
    {
        errorMessage = message;
        StateHasChanged(); // Update the UI to show the error message

        // Wait for 2.5 seconds before clearing the error message
        await Task.Delay(2500);

        errorMessage = string.Empty; // Clear the error message
        StateHasChanged(); // Update the UI to hide the error message
    }
    #endregion

#region RESULTS HANDLING

    #region HANDLE MULTIPLE SEARCH RESULTS
    private async Task HandleMultipleResults()
    //intended flow: if response returns more than one result, show modal with result options
    {
        await OnMultipleResultsFound.InvokeAsync(searchResults);
    }
    #endregion

    #region HANDLE ONE RESULT
    private async void HandleSingleResult(SearchModel singleResult)
    {
        if (singleResult.MovieDetails != null)
        {
            OnMovieSelected(singleResult.MovieDetails);
        }
        else
        {
            await ShowErrorMessage("Movie details are not available.");
        }
    }
    #endregion

    #region RESULT ROUTING
        private void OnMovieSelected(MovieDetails movieDetails)
        {
            if (movieDetails is not null)
            {
                NavigationManager.NavigateTo($"/movie/{movieDetails.Id}");
            }
            else
            {
                errorMessage = "Movie details are not available.";
            }
        }
    #endregion

     #endregion
}
