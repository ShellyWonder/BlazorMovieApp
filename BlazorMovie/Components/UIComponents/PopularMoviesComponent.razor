@* displayed on the home page *@
@using System.Text.Json
@using BlazorMovie.Services
@using BlazorMovie.Models
@using BlazorMovie.Models.Interfaces

@inject TMDBClient TMDB
@inject NavigationManager navManager
@inject IMovieService<PopularMovie> PopularMovieService
@inject IJSRuntime JSRuntime

<MovieListComponent TMovie="PopularMovie" movies="@movies" Title="Popular Movies" OnPageChanged="GetPage" />


@code {
    private PageResponse<PopularMovie>? movies;
    

    [Parameter]
    public string? Title { get; set; } = "Popular Movies";


    [SupplyParameterFromQuery]
    public int Page { get; set; } = 1;

    protected override async Task OnParametersSetAsync()
    {  
        // Check if data is already in sessionStorage
        var cachedMoviesJson = await JSRuntime.InvokeAsync<string>("sessionStorageHelper.getItem", $"popularMoviesPage{Page}");

        if (string.IsNullOrEmpty(cachedMoviesJson))
        {
            // No cached data, make the API call
            movies = await PopularMovieService.GetMoviesAsync(Page);

            // Store the API response in sessionStorage for future use
            if (movies != null)
            {
                // Serialize the entire PageResponse<PopularMovie> object to JSON and store it
                var moviesJson = JsonSerializer.Serialize(movies);
                await JSRuntime.InvokeVoidAsync("sessionStorageHelper.setItem", $"popularMoviesPage{Page}", movies);
            }
        }
        else
        {
            // Data exists, deserialize the cached data
            movies = System.Text.Json.JsonSerializer.Deserialize<PageResponse<PopularMovie>>(cachedMoviesJson);
        }
    }
    private void GetPage(int pageNum)
    {
        string url = navManager.GetUriWithQueryParameter("page", pageNum);
        navManager.NavigateTo(url);
    }
}


